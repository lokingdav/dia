---
- name: Setup and manage DIA infrastructure
  hosts: all
  become: yes
  vars_files:
    - vars.yml
    - vars.env.yml

  handlers:
    - name: Restart asterisk
      ansible.builtin.systemd:
        name: asterisk
        state: restarted
      delegate_to: "{{ asterisk_host }}"
      run_once: true

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: yes


  tasks:
    # ============================================================================
    # SETUP TASKS (ordering: wait_for -> asterisk -> others -> baresip)
    # ============================================================================

    - name: Wait for user data completion
      ansible.builtin.wait_for:
        path: "{{ user_data_done_file }}"
        timeout: "{{ user_data_wait_timeout }}"
      tags: [setup, wait]

    - name: Compute asterisk inventory host name
      ansible.builtin.set_fact:
        asterisk_host: >-
          {{
            (hostvars
              | dict2items
              | selectattr('value.type', 'defined')
              | selectattr('value.type', 'equalto', 'asterisk')
              | map(attribute='key')
              | list
            )[0]
          }}
      run_once: true
      tags: [setup, asterisk]

    # --- ASTERISK SETUP FIRST (runs once, delegated to the asterisk host) ---
    - name: Install Asterisk packages on asterisk instance (apt)
      ansible.builtin.apt:
        name:
          - asterisk
          - asterisk-core-sounds-en
          - asterisk-moh-opsound-wav
          - asterisk-modules
          - net-tools
          - tcpdump
        state: present
      delegate_to: "{{ asterisk_host }}"
      run_once: true
      tags: [setup, asterisk]

    - name: Ensure Asterisk is enabled (do not force stop/start here)
      ansible.builtin.systemd:
        name: asterisk
        enabled: yes
      delegate_to: "{{ asterisk_host }}"
      run_once: true
      tags: [setup, asterisk]

    - name: Set Asterisk external address on asterisk host from inventory ansible_host
      ansible.builtin.set_fact:
        asterisk_externaddr: "{{ hostvars[asterisk_host].ansible_host }}"
      delegate_to: "{{ asterisk_host }}"
      delegate_facts: true
      run_once: true
      tags: [setup, asterisk]

    - name: Deploy Asterisk PJSIP configuration (templated)
      ansible.builtin.template:
        src: asterisk/pjsip.conf.j2
        dest: /etc/asterisk/pjsip.conf
        owner: root
        group: root
        mode: "0644"
      delegate_to: "{{ asterisk_host }}"
      run_once: true
      no_log: true
      vars:
        asterisk_externaddr: "{{ hostvars[asterisk_host].ansible_host }}"
      notify: Restart asterisk
      tags: [setup, asterisk]

    - name: Deploy Asterisk dialplan (extensions.conf)
      ansible.builtin.copy:
        src: asterisk/extensions.conf
        dest: /etc/asterisk/extensions.conf
        owner: root
        group: root
        mode: "0644"
        force: yes
      delegate_to: "{{ asterisk_host }}"
      run_once: true
      notify: Restart asterisk
      tags: [setup, asterisk]

    - name: Deploy Asterisk RTP configuration (rtp.conf)
      ansible.builtin.copy:
        src: asterisk/rtp.conf
        dest: /etc/asterisk/rtp.conf
        owner: root
        group: root
        mode: "0644"
        force: yes
      delegate_to: "{{ asterisk_host }}"
      run_once: true
      notify: Restart asterisk
      tags: [setup, asterisk]

    - name: Flush handlers so Asterisk restarts before clients configure/register
      ansible.builtin.meta: flush_handlers
      run_once: true
      tags: [setup, asterisk]

    - name: Start Asterisk service
      ansible.builtin.systemd:
        name: asterisk
        state: started
      delegate_to: "{{ asterisk_host }}"
      run_once: true
      tags: [setup, asterisk]

    - name: Set asterisk_externaddr for clients (from inventory asterisk host)
      ansible.builtin.set_fact:
        asterisk_externaddr: "{{ hostvars[asterisk_host].ansible_host }}"
      when: type == 'client'
      tags: [setup, baresip]

    # ============================================================================
    # DIA REPO/DOCKER SETUP (CLIENTS + SERVER)
    # ============================================================================

    - name: Ensure repository destination directory exists
      ansible.builtin.file:
        path: "{{ repo_dest }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"
      when: type in ['client', 'server']
      tags: [setup, clone]

    - name: Clone repository
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: "{{ repo_branch }}"
        force: yes
      become_user: ubuntu
      when: type in ['client', 'server']
      tags: [setup, clone, checkout_branch]

    - name: Checkout branch
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: "{{ repo_branch }}"
        update: yes
      become_user: ubuntu
      when: type in ['client', 'server']
      tags: [checkout_branch]

    - name: Copy environment file
      ansible.builtin.copy:
        src: "../{{ env_files[inventory_hostname] }}"
        dest: "{{ repo_dest }}/.env"
        owner: ubuntu
        group: ubuntu
        mode: "0644"
      when: type in ['client', 'server']
      tags: [setup, copy_env]

    - name: Pull dia Docker image
      community.docker.docker_image:
        name: "{{ dia_image }}"
        source: pull
        force_source: yes
      when: type in ['client', 'server']
      tags: [setup, pull_images]

    - name: Pull redis Docker image
      community.docker.docker_image:
        name: "{{ redis_image }}"
        source: pull
        force_source: yes
      when: type == 'server'
      tags: [setup, pull_images]

    - name: Verify Docker is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes
      when: type in ['client', 'server']
      tags: [setup, verify]

    # ============================================================================
    # BARESIP SETUP (CLIENTS ONLY) - configs always redeployed
    # ============================================================================

    - name: Install baresip packages on client instances (apt)
      ansible.builtin.apt:
        name:
          - baresip
          - baresip-core
          - libasound2t64
          - libpulse0
          - pulseaudio
          - alsa-utils
          - net-tools
        state: present
      when: type == 'client'
      tags: [setup, baresip]

    - name: Copy baresip configuration directory to clients (always overwrite)
      ansible.builtin.copy:
        src: baresip/
        dest: /home/ubuntu/.baresip/
        owner: ubuntu
        group: ubuntu
        mode: "0755"
        force: yes
      when: type == 'client'
      tags: [setup, baresip]

    - name: Deploy baresip accounts (templated)
      ansible.builtin.template:
        src: baresip/accounts.j2
        dest: /home/ubuntu/.baresip/accounts
        owner: ubuntu
        group: ubuntu
        mode: "0644"
      no_log: true
      when: type == 'client'
      tags: [setup, baresip]

    - name: Set proper permissions on baresip files
      ansible.builtin.file:
        path: /home/ubuntu/.baresip
        owner: ubuntu
        group: ubuntu
        mode: "0755"
        recurse: yes
      when: type == 'client'
      tags: [setup, baresip]

    - name: Copy baresip systemd service file
      ansible.builtin.copy:
        src: baresip/baresip.service
        dest: /etc/systemd/system/baresip.service
        owner: root
        group: root
        mode: "0644"
        force: yes
      when: type == 'client'
      notify: Reload systemd
      tags: [setup, baresip]


    - name: Reload systemd daemon (clients)
      ansible.builtin.systemd:
        daemon_reload: yes
      when: type == 'client'
      tags: [setup, baresip]

    - name: Enable and start baresip service
      ansible.builtin.systemd:
        name: baresip
        enabled: yes
        state: started
      when: type == 'client'
      tags: [setup, baresip]

    # ============================================================================
    # STOP TASKS
    # ============================================================================

    - name: Stop baresip service on clients
      ansible.builtin.systemd:
        name: baresip
        state: stopped
      when: type == 'client'
      ignore_errors: yes
      tags: [stop_baresip, restart_baresip]

    - name: Stop Asterisk service on asterisk server
      ansible.builtin.systemd:
        name: asterisk
        state: stopped
      when: type == 'asterisk'
      ignore_errors: yes
      tags: [stop_asterisk, restart_asterisk]

    - name: Stop all Docker Compose services
      ansible.builtin.command: docker compose --profile es --profile rs down
      args:
        chdir: "{{ repo_dest }}"
      become_user: ubuntu
      ignore_errors: yes
      tags: [stop, stop_services, restart_services]

    # ============================================================================
    # START TASKS
    # ============================================================================

    - name: Start baresip service on clients
      ansible.builtin.systemd:
        name: baresip
        state: started
      when: type == 'client'
      tags: [start_baresip, restart_baresip]

    - name: Start Asterisk service on asterisk server
      ansible.builtin.systemd:
        name: asterisk
        state: started
      when: type == 'asterisk'
      tags: [start_asterisk, restart_asterisk]

    - name: Start enrollment server and relay server on server instance
      ansible.builtin.command: docker compose --profile es --profile rs up -d
      args:
        chdir: "{{ repo_dest }}"
      become_user: ubuntu
      environment:
        DOCKER_BUILDKIT: "1"
        COMPOSE_DOCKER_CLI_BUILD: "1"
      when: type == 'server'
      tags: [start, start_services, restart_services]

    - name: Wait for services to be healthy
      ansible.builtin.pause:
        seconds: 10
      when: type == 'server'
      tags: [start, start_services]

    - name: Show running containers
      ansible.builtin.command: docker ps
      become_user: ubuntu
      register: docker_ps
      tags: [start, start_services, verify]

    - name: Display running containers
      ansible.builtin.debug:
        var: docker_ps.stdout_lines
      tags: [start, start_services, verify]

    # ============================================================================
    # STOP TASKS (duplicate in original; kept as-is for drop-in compatibility)
    # ============================================================================

    - name: Stop all Docker Compose services
      ansible.builtin.command: docker compose --profile es --profile rs down
      args:
        chdir: "{{ repo_dest }}"
      become_user: ubuntu
      ignore_errors: yes
      tags: [stop, stop_services]

    # ============================================================================
    # LOGS TASKS
    # ============================================================================

    - name: Clear application logs directory
      ansible.builtin.file:
        path: "{{ log_path }}"
        state: absent
      tags: [logs, clear_logs]

    - name: Recreate logs directory
      ansible.builtin.file:
        path: "{{ log_path }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"
      tags: [logs, clear_logs]

    - name: Prune Docker logs
      ansible.builtin.command: docker system prune -f --volumes
      become_user: ubuntu
      tags: [logs, clear_logs]
