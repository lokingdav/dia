x-dia-server: &dia-server-base
  image: kofidahmed/dia
  working_dir: /app
  entrypoint: ["air"]
  volumes:
    - .:/app
    - go-mod-cache:/go/pkg/mod
    - go-build-cache:/root/.cache/go-build  # Share build cache
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "nc", "-z", "localhost", "50051"]
    interval: 30s
    timeout: 5s
    retries: 3
    start_period: 30s  # Give more time for initial build
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  environment:
    - GOCACHE=/root/.cache/go-build
    - GOMODCACHE=/go/pkg/mod

services:
  enrollment-server:
    <<: *dia-server-base
    container_name: enrollment-server
    command:
      - "--build.cmd=go build -o /app/bin/es /app/cmd/enrollment"
      - "--build.bin=/app/bin/es"
    ports:
      - "50051:50051"
    env_file: .env
    profiles: [es]

  relay-server:
    <<: *dia-server-base
    container_name: relay-server
    command:
      - "--build.cmd=go build -o /app/bin/rs /app/cmd/relay"
      - "--build.bin=/app/bin/rs"
    ports:
      - "50052:50051"
    env_file: .env
    profiles: [rs]
    depends_on:
      redis:
        condition: service_healthy

  expctrl:
    <<: *dia-server-base
    container_name: expctrl
    # Long-running container so you can `docker exec -it controller ...`
    # to run ad-hoc commands (e.g. ./controller.sh, go run, etc.).
    entrypoint: ["/bin/sh", "-lc"]
    command: ["sleep infinity"]
    healthcheck:
      disable: true
    stdin_open: true
    tty: true
    env_file:
      - .env
      - .env.ctrl
    profiles: [expctrl]
    depends_on:
      redis:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    profiles: [rs, expctrl]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  go-mod-cache:
    driver: local
  go-build-cache:  # New shared build cache
    driver: local
  redis-data:
    driver: local
