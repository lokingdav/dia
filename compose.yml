x-denseid-server: &denseid-server-base
  image: denseid-dev
  working_dir: /app
  entrypoint: ["air"]
  volumes:
    - .:/app
    - go-mod-cache:/go/pkg/mod
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "sh", "-c", "nc -z localhost 50051"]
    interval: 30s
    timeout: 5s
    retries: 3
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 500M

services:
  # enrollment-server:
  #   <<: *denseid-server-base
  #   container_name: enrollment-server
  #   command:
  #     - "--build.cmd=go build -o /app/bin/es /app/cmd/enrollment"
  #     - "--build.bin=/app/bin/es"
  #   ports:
  #     - "50051:50051"
  #   env_file: .env
  #   profiles: [es]

  key-derivation:
    <<: *denseid-server-base
    container_name: key-derivation
    command:
      - "--build.cmd=go build -o /app/bin/kd /app/cmd/keyderivation"
      - "--build.bin=/app/bin/kd"
    ports:
      - "50052:50051"
    env_file: .env
    profiles: [ks]

  # revocation-server:
  #   <<: *denseid-server-base
  #   container_name: revocation-server
  #   command:
  #     - "--build.cmd=go build -o /app/bin/rv /app/cmd/revocation"
  #     - "--build.bin=/app/bin/rv"
  #   ports:
  #     - "50053:50051"
  #   env_file: .env
  #   profiles: [rv]

  relay-server:
    <<: *denseid-server-base
    container_name: relay-server
    command:
      - "--build.cmd=go build -o /app/bin/rs /app/cmd/relay"
      - "--build.bin=/app/bin/rs"
    ports:
      - "50054:50051"
    env_file: .env
    profiles: [rs]
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    profiles: [rs]

volumes:
  go-mod-cache:
  redis-data:
